# Biological interpretation of findings
In this chapter we will explain the steps for the biological interpretation of
the findings. A file with the slides can be downloaded [here](./Slides/ISG_summer_school_EWAS5.pdf)

At the end of the practice, please answer these questions:

1. Which is the top 1 enriched GO term in current smokers? and in former smokers?
2. Which are the enriched KEGG pathways in current smokers? and in former smokers?
3. Which are the enriched tissues in current smokers? and informer smokers?


We will need to load some libraries:
```{r libs_annot, eval=FALSE}
library(IlluminaHumanMethylation450kanno.ilmn12.hg19)
library(clusterProfiler)
library(org.Hs.eg.db)
library(enrichplot)
```

## Load MetaEWAS results
We begin loading the Never vs Current FDR significant metaEWAS results 
```{r loadenrich}
metaEWAS.FDRsig <- read.table(file = "./data/DAY5/Input/MA.Smoking.NeverVScurrent.FDRsig.txt",
                              sep=" ",
                              header = TRUE)
head(metaEWAS.FDRsig)
```


## Annotation of CpG sites
Once we have obtained a list with the CpGs that are significant in our analysis,
we need to locate them in the genome and try to know which structures 
surround them. The annotation consists in obtaining this information:

First we load the annotation from `IlluminaHumanMethylation450kanno.ilmn12.hg19`
R package and select the columns of interest
```{r IlluminaAnnotation}
data("IlluminaHumanMethylation450kanno.ilmn12.hg19")
annotation.table<- getAnnotation(IlluminaHumanMethylation450kanno.ilmn12.hg19)
dim(annotation.table)
annotation.table<-as.data.frame(annotation.table[,c("chr","pos","strand",
                                                    "Name","Islands_Name",
                                                    "Relation_to_Island",
                                                    "UCSC_RefGene_Name",
                                                    "UCSC_RefGene_Group")])
head(annotation.table)
```

Merge our significant metaEWAS results with the annotation. 
```{r merge}
metaEWAS.ann<-merge(metaEWAS.FDRsig, annotation.table,by.x="probe",by.y="Name")
metaEWAS.ann.ord<-metaEWAS.ann[order(metaEWAS.ann$p.fe),]

head(metaEWAS.ann.ord)
```

Create list of Genes for Enrichment and save list of FDR CpGs and FDR genes
```{r listGenes}
ann.genes.current<-metaEWAS.ann.ord$UCSC_RefGene_Name
ann.genes.current <- unlist(lapply(strsplit(ann.genes.current, ";"), unique))

### 4.4. Save results 
write.table(metaEWAS.FDRsig$probe,"./data/DAY5/Output/list.cpgs.MA.Smoking.NeverVScurrent.txt", row.names = F, col.names = F, quote = F)
write.table(metaEWAS.FDRsig$probe[1:1000],"./data/DAY5/Output/list.cpgs.MA.Smoking.NeverVScurrent_subset.txt", row.names = F, col.names = F, quote = F)

write.table(ann.genes.current,"./data/DAY5/Output/list.genes.MA.Smoking.NeverVScurrent.txt", row.names = F, col.names = F, quote = F)
```


## Functional enrichment analysis
The idea is to compare the list of genes that overlap our CpGs with the list of 
all the human genes that are anotated in specific databases. With this, we can see
if our list of genes is a random subset or no.

First of all we convert Gene Symbols to Ensembl and Entrez Gene IDs to use them later
```{r nameconversion, warning=FALSE}
ids <- bitr(ann.genes.current, fromType="SYMBOL", toType=c("ENSEMBL", "ENTREZID"), OrgDb="org.Hs.eg.db")
```
### GO

We will first work with the Gene Ontology (GO) database, that allows us to see if a
specific gene function is overrepresented in our gene list. We need to obtain the
list of all human genes that are curated in GO.
```{r genelist}
# GO
df = as.data.frame(org.Hs.egGO)
go_gene_list = unique(sort(df$gene_id))
```

And then run the analyses and keep the most interesting results.
```{r goresults}
ans.go <- enrichGO(gene = ids$ENTREZID,
                   ont = "BP",
                   OrgDb ="org.Hs.eg.db",
                   universe = go_gene_list,
                   readable=TRUE,
                   pvalueCutoff = 0.05)

tab.go <- as.data.frame(ans.go)
tab.go<- subset(tab.go, Count>5)
head(tab.go)
```

Finally we can perform different type of plots to see the results in a graphical way
```{r goplotss}
p1 <- barplot(ans.go, showCategory=10) + ggtitle('Never vs Current Smokers') + theme(plot.title = element_text(size = 18))
p1
ans.go <- pairwise_termsim(ans.go)
p2 <- emapplot(ans.go, cex_label_category = 0.5, showCategory = 20) + ggtitle('Never vs Current Smokers') + theme(plot.title = element_text(size = 18))
p2
```

### Reactome
Now we do the same for the Reactome database
```{r reactresults, eval=FALSE}
ans.react <- enrichPathway(gene=ids$ENTREZID, pvalueCutoff = 0.05, readable=TRUE)
tab.react <- as.data.frame(ans.react)
tab.react<- subset(tab.react, Count>5)
head(tab.react)
```

### Disease
To be provided
```{r, eval=FALSE, include=FALSE}
ans.do <- enrichDO(gene     = ids$`ncbi-geneid`,
              ont           = "DO",
              pvalueCutoff  = 0.05,
              pAdjustMethod = "BH",
              universe      = names(geneList),
              minGSSize     = 5,
              maxGSSize     = 500,
              qvalueCutoff  = 0.05,
              readable      = FALSE)

ncg <- enrichNCG(ids$`ncbi-geneid`)
```
### Online Tools

The functional enrichment can also be done online with some interesting tools:

[**eFORGE**](https://eforge.altiusinstitute.org/) is used to identify cell-type
or tissue-type specific signals in epigenomic data by looking at the overlap between 
differentially methylated positions (DMPs) with DNase I hypersensitive sites (DHSs) 


[**EWAS Catalog**](http://www.ewascatalog.org/) is a huge database of EWAS results.
We can submit the names of our top CpGs to see the last published information about them



**ANSWERS**

1. For current smokers it is the regulation of neuron projection development. For former smokers it is

